#!/bin/bash
ArchitectureSel () {
	case "$(uname -m)" in
		aarch64) ;;
		i686) ;;
		x86_64) ;;
	esac
}


UEFISel () {
	if [[ "$(cat /sys/class/dmi/id/sys_vendor)" == 'Apple Inc.' ]] || [[ "$(cat /sys/class/dmi/id/sys_vendor)" == 'Apple Computer, Inc.' ]]
	then modprobe -r -q efivars || true # if MAC
	else	modprobe -q efivarfs # all others
	fi
	
	if [[ -d "/sys/firmware/efi/" ]]; then	## Mount efivarfs if it is not already mounted
		if (mount | grep /sys/firmware/efi/efivars)
		then mount -t efivarfs efivarfs /sys/firmware/efi/efivars
		fi
	UefiMode=1 && echo "UEFI Mode detected"
	else
	UefiMode=0 && echo "BIOS Mode detected"
	fi
}

NvidiaSel () {
  if echo "$GCard" | grep -q "NVIDIA"; then
  YesNoSel "Install NVIDIA proprietary driver"
    case "$CC" in
      1) NVIDIA_DRIVER="nvidia" ;;
      0) NVIDIA_DRIVER="nouveau" ;;
      *) NVIDIA_DRIVER="nvidia" ;;
    esac
  fi
}

IntelSel () {
  if echo "$GCard" | grep -q "Intel"; then
  YesNoSel "Install Intel driver"
    case "$CC" in
      1) INTEL_DRIVER="mesa" ;;
      0) INTEL_DRIVER="xf86-video-intel" ;;
      *) INTEL_DRIVER="mesa" ;;
    esac
  fi
}

AmdSel () {
  if echo "$GCard" | grep -q "Advanced"; then
  YesNoSel "Install AMDGPU driver"
    case "$CC" in
      1) AMD_DRIVER="amdgpu" ;;
      0) AMD_DRIVER="ati" ;;
      *) AMD_DRIVER="amdgpu" ;;
    esac
  fi
}

GraphicSel () {
  echo " Detecting video chipset "
  GCard=$(lspci | grep VGA)
  GCard_length=$(lspci | grep -c VGA)
  
  if [[ $GCard_length -eq 2 ]]; then 
    echo 'Optimus driver'
    AmdSel
    IntelSel
    NvidiaSel
  fi  
}

Pacman_Locked() {
	if [[ -f /var/lib/pacman/db.lck || /mnt/var/lib/pacman/db.lck ]]; then
		echo -e " !!!ERROR!!! Pacman is blocked. \n We try to remove /var/lib/pacman/db.lck."
		rm /var/lib/pacman/db.lck || /mnt/var/lib/pacman/db.lck
	else echo "No locked database"
	fi
}
